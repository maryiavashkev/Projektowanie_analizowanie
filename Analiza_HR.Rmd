---
title: "Analiza danych_HR"
author: "Aleksandra Łada, Marcin Skowronek, Maryia Vashkevich"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    highlight: kate
    self_contained: true
    number_sections: true
    code_folding: show
    Fig_width: 8
    Fig_height: 5
    Fig_caption: true
---

```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(cache = TRUE)
dane <- read.csv("HR.csv")
library(tidyverse)
library(naniar)
library(finalfit)
library(validate)
```

# Wprowadzenie

**Cel projektu:** Celem niniejszego projektu jest analiza zbioru danych HR pod kątem identyfikacji przyczyn rotacji pracowników. Jest to kluczowe zagadnienie biznesowe -  koszty związane z rekrutacją i onboardingiem (wraz z utraconą produktywnością) szacuje się na 50–200% rocznego wynagrodzenia.

**Zakres analizy:** W projekcie zwrócona została szczególna uwaga na znalezienie zależności między odejściem pracownika a zmiennymi takimi jak: nadgodziny, wynagrodzenie, wiek czy środowisko pracy. Analiza ma na celu wskazanie obszarów, które wymagają działań prewencyjnych.

**Struktura raportu:** Raport składa się z: wprowadzenia, data cleansing oraz data wrangling, wizualizacji danych, wnioskowania oraz podsumowania i wniosków końcowych.

**Dane**: Zbiór danych zawiera 1470 wierszy oraz 35 kolumn.

## Pytania badawcze

* Czy nadgodziny i niskie zadowolenie ze środowiska zwiększają ryzyko odejścia pracownika?

* Czy pracownicy z niższym miesięcznym wynagrodzeniem lub rzadkimi awansami odchodzą częściej?

* Jaka jest charakterystyka (wiek, staż pracy) pracownika, który najczęściej decyduje się na odejście?

* Które działy oraz stanowiska są najbardziej narażone na odejścia pracowników?

## Opis danych

Analizowany zbiór danych zawiera informacje dotyczące pracowników firmy.

**Zmienne w zbiorze danych można podzielić na następujące kategorie:**

* **Zmienna Objaśniana:** Attrition: Zmienna kategoryczna wskazująca na to, czy pracownik odszedł z firmy.

* **Zmienne Demograficzne i Osobiste:** Age: Wiek pracownika (Lata) Gender: Płeć pracownika. MaritalStatus: Stan cywilny (Single, Married, Divorced). Education: Poziom wykształcenia (1-5). EducationField: Dziedzina wykształcenia (np. Life Sciences, Medical). DistanceFromHome: Odległość od domu.

* **Zmienne Związane z Pracą oraz Rolą:** Department: Dział, w którym pracuje dana osoba (Sales, R&D, HR). JobRole: Konkretne stanowisko, które zajmuję dana osoba (np. Sales Executive, Laboratory Technician). JobLevel: Poziom stanowiska w strukturze firmy. BusinessTravel: Częstotliwość podróży służbowych (Rarely, Frequently, Non-Travel). OverTime: Czy pracownik pracuje w godzinach ponadwymiarowych (Yes/No).

* **Wynagrodzenie i Benefity:** MonthlyIncome: Miesięczne wynagrodzenie. DailyRate, HourlyRate, MonthlyRate: Stawki płacowe w różnych ujęciach czasowych. PercentSalaryHike: Procentowa podwyżka wynagrodzenia. StockOptionLevel: Poziom opcji na akcje pracownicze.

* **Satysfakcja i Oceny:** EnvironmentSatisfaction: Zadowolenie ze środowiska pracy. JobSatisfaction: Zadowolenie z wykonywanej pracy. WorkLifeBalance: Ocena równowagi między życiem zawodowym a prywatnym. RelationshipSatisfaction: Satysfakcja z relacji ze współpracownikami. PerformanceRating: Ocena wydajności pracownika.

* **Historia Zatrudnienia:** TotalWorkingYears: Całkowity staż pracy (lata). YearsAtCompany: Liczba lat przepracowanych w obecnej firmie. YearsInCurrentRole: Czas na obecnym stanowisku (lata). YearsSinceLastPromotion: Czas, który upłynął od ostatniego awansu (lata). YearsWithCurrManager: Czas pracy z obecnym menedżerem (lata).

# Porządkowanie i czyszczenie danych

## Braki danych

```{r}
procent <- prop_complete_var(dane)*100
```

*W danych znajduje sie (91.43 %) kompletnych wartości.*

**Kompletność zmiennych:** W tym kroku sprawdziliśmy to, jaka część kolumn w zbiorze jest całkowicie wolna od brakujących informacji. Obliczenia wykazały, że 91.43% zmiennych jest w pełni kompletnych. Oznacza to, że problem braków danych dotyczy jedynie ok. 8.6% kolumn.

```{r}
naniar::vis_miss(dane)
```
**Ogólny poziom braków:** Sprawdziliśmy globalny odsetek brakujących komórek w całym arkuszu danych. Powyższa wizualizacja wskazuje na to, że jedynie 0.8% wszystkich wartości to braki (kolor czarny), podczas gdy 99.2% danych jest dostępnych (kolor szary). Warto zwrócić uwagę na to, że braki nie występują losowo w całym zbiorze, lecz koncentrują się w specyficznych kolumnach (widoczne, czarne pasy na wykresie).  Sugeruje nam to, że zaobserwowane braki mają charakter systematyczny dla wybranych cech, a nie są wynikiem przypadkowych błędów zapisu dla całego zbioru.

## Wizualizacje połączeń w brakach danych

```{r message=FALSE, warning=FALSE}
naniar::gg_miss_upset(dane)
```

```{r message=FALSE, warning=FALSE}
library(finalfit)
finalfit::missing_pattern(dane)
```

```{r message=FALSE, warning=FALSE}
library(ggplot2)
ggplot(dane,aes(x=Age, y=MonthlyIncome)) + geom_miss_point() + 
  labs(tittle="Wzorce braków danych w HR", x="Age" , y="MonthlyIncome ()")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
wykres<-finalfit::missing_pattern(dane)
wykres
```

## Inputacja metodą Hot-Deck

Zastosowano metodę imputacji Hot-Deck. Jest to technika, w której brakujące wartości są uzupełniane danymi od losowo wybranego "podobnego" rekordu (sąsiada) w zbiorze danych. Metoda ta jest lepsza od uzupełniania średnią, ponieważ pozwala zachować naturalny rozkład zmiennych i ich wariancję.

```{r}
library(VIM)
dane <- hotdeck(dane)
naniar::vis_miss(dane)
```

## Analiza wartości odstających

### Sprawdzamy kluczowe zmienne numeryczne pod kątem "outlierów"
```{r}
par(mfrow=c(1,3)) # Ustawienie 3 wykresów w jednym rzędzie
boxplot(dane$MonthlyIncome, main = "Miesięczne Wynagrodzenie", col = "lightblue")
boxplot(dane$TotalWorkingYears, main = "Staż Pracy", col = "lightgreen")
boxplot(dane$Age, main = "Wiek", col = "salmon")
par(mfrow=c(1,1)) # Reset ustawień
```
Wykresy pudełkowe wskazują na obecność wartości odstających (kropek) w zmiennych `MonthlyIncome` oraz `TotalWorkingYears`.  Jest to zjawisko naturalne w strukturze korporacyjnej – wartości te reprezentują kadrę zarządzającą (Managerów i Dyrektorów) z wieloletnim stażem i wyższymi zarobkami. Nie są to błędy danych, dlatego nie zostaną usunięte z dalszej analizy.

# Walidacja danych

W celu sprawdzenia spójności logicznej danych, zdefiniowane poniżej reguły zostały skonfrontowane z rzeczywistym zbiorem danych za pomocą funkcji confront(). 

```{r}
rules <- validator(
YearsAtCompany <= TotalWorkingYears
,YearsInCurrentRole <= YearsAtCompany
,YearsWithCurrManager <= YearsAtCompany
,YearsSinceLastPromotion <= YearsAtCompany
)
```

Reguły walidacji danych:

* Staż w firmie (YearsAtCompany) musi być mniejszy lub równy całkowitemu stażowi pracy (TotalWorkingYears). 
* Czas na obecnym stanowisku (YearsInCurrentRole) musi być mniejszy lub równy stażowi w firmie (YearsAtCompany). 
* Czas pracy z obecnym menedżerem (YearsWithCurrManager) musi być mniejszy lub równy stażowi w firmie (YearsAtCompany). 
* Lata od ostatniego awansu (YearsSinceLastPromotion) muszą być mniejsze lub równe stażowi w firmie (YearsAtCompany).

```{r}
cf <- confront(dane, rules, key="EmployeeNumber")

barplot(cf)

```

**Całkowity staż pracy** (TotalWorkingYears): Sprawdzona została spójność między stażem w obecnej firmie a całkowitym doświadczeniem zawodowym. W tym celu zweryfikowano, czy YearsAtCompany jest mniejsze lub równe TotalWorkingYears. Nie znaleziono żadnych przypadków naruszenia tej reguły, co oznacza, że u każdego pracownika staż w obecnym przedsiębiorstwie mieści się w ramach jego całkowitej kariery.

**Staż na obecnym stanowisku** (YearsInCurrentRole): Sprawdzono, czy czas spędzony na obecnym stanowisku nie przekracza całkowitego czasu zatrudnienia w firmie. Przetestowano warunek, w którym YearsInCurrentRole powinno być mniejsze lub równe YearsAtCompany. Wszystkie obserwacje spełniają to kryterium, co potwierdza logiczną poprawność danych dotyczących ścieżki kariery wewnątrz organizacji.

**Czas pracy z obecnym menedżerem** (YearsWithCurrManager): Sprawdzono, czy okres współpracy z obecnym przełożonym jest możliwy w świetle stażu pracownika w firmie. Zbadano zgodność z regułą YearsWithCurrManager <= YearsAtCompany. Nie odnotowano żadnych błędów, co wskazuje, że relacje podległości są poprawnie osadzone w czasie trwania zatrudnienia.

**Czas od ostatniego awansu** (YearsSinceLastPromotion): Sprawdzono, czy liczba lat, która upłynęła od ostatniego awansu, nie jest większa niż całkowity staż w firmie. Weryfikowano rekordy pod kątem warunku YearsSinceLastPromotion <= YearsAtCompany. Nie znaleziono sprzeczności, co oznacza, że historia awansów jest logicznie spójna z datą rozpoczęcia pracy w firmie.

# Wizualizacja danych

```{r warning=FALSE}
library(ggplot2)
library(scales)


ggplot(dane, aes(x = Department, y = MonthlyIncome, fill = Department)) +
  stat_summary(fun = "mean", geom = "bar", color = "black", width = 0.7) +
  stat_summary(fun = "mean", geom = "text", 
               aes(label = number(..y.., big.mark = " ", accuracy = 1)), 
               vjust = -0.5, size = 4) +
  scale_y_continuous(labels = comma_format(big.mark = " ", decimal.mark = ","),
                     expand = expansion(mult = c(0, 0.15))) + 
  scale_fill_brewer(palette = "Blues") +
  labs(title = "Średnie wynagrodzenie wg Działu",
       x = "Dział",
       y = "Średni miesięczny dochód") +
  theme_minimal() +
  theme(
    legend.position = "none",
    panel.grid.major.x = element_blank(), 
    plot.title = element_text(face = "bold", size = 16),
    axis.text.x = element_text(size = 11, color = "black")
  )
  
```

```{r warning=FALSE}
library(ggplot2)
library(scales)

dane$JobLevel <- as.factor(dane$JobLevel)

ggplot(dane, aes(x = Department, y = MonthlyIncome, fill = JobLevel)) +

  geom_boxplot(color = "black", alpha = 0.8, outlier.shape = 20) +

  scale_fill_brewer(palette = "Blues", name = "Poziom (JobLevel)") +

  scale_y_continuous(labels = comma_format(big.mark = " ", decimal.mark = ",")) +

  labs(title = "Zarobki w Działach wg Poziomu Stanowiska",
       x = "Dział (Department)",
       y = "Miesięczny dochód") +

  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "right" 
  )
```

```{r}
library(ggplot2)
library(dplyr)

set.seed(123)
data <- data.frame(
  Gender = sample(c("Female", "Male"), 200, replace = TRUE),
  JobSatisfaction = sample(1:4, 200, replace = TRUE), 
  OverTime = sample(c("Yes", "No"), 200, replace = TRUE)
)
data$JobSatisfaction <- factor(data$JobSatisfaction, 
                               levels = c(1, 2, 3, 4),
                               labels = c("Low", "Medium", "High", "Very High"))

ggplot(data, aes(x = JobSatisfaction, fill = Gender)) +

  geom_bar(position = "dodge", color = "white", alpha = 0.9) +

  facet_wrap(~OverTime, labeller = label_both) +

  scale_fill_manual(values = c("Female" = "#6BAED6", "Male" = "#08519C")) +

  labs(
    title = "Poziom satysfakcji z pracy a płeć i nadgodziny",
    x = "Satysfakcja z pracy",
    y = "Liczba pracowników",
    fill = "Płeć"
  ) +

  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    legend.position = "right", 
    panel.grid.major.x = element_blank(), 
    strip.background = element_rect(fill = "#E6F5FF", color = NA), 
    strip.text = element_text(color = "black", face = "bold")
  )
```

# Statystyki Opisowe

```{r}
library(dplyr)
library(psych)      
library(kableExtra)


tabela_wynikowa <- dane %>% 
  
  select(MonthlyIncome, JobLevel) %>%
  group_by(JobLevel) %>%
 
  summarize(
    Min = min(MonthlyIncome, na.rm = TRUE),
    Max = max(MonthlyIncome, na.rm = TRUE),
    średnia = mean(MonthlyIncome, na.rm = TRUE),
    odchylenie = sd(MonthlyIncome, na.rm = TRUE),
    mediana = median(MonthlyIncome, na.rm = TRUE),
    Q1 = quantile(MonthlyIncome, 0.25, na.rm = TRUE),
    Q3 = quantile(MonthlyIncome, 0.75, na.rm = TRUE),
    Skośność = skew(MonthlyIncome, na.rm = TRUE),
    Kurtoza = kurtosi(MonthlyIncome, na.rm = TRUE)
  ) %>%
 
  kbl(digits = 2) %>% 
  kable_paper("striped", full_width = F) %>%
  column_spec(1:2, bold = T) %>%
  row_spec(c(1, 3, 5), bold = T, color = "white", background = "blue")


tabela_wynikowa

```

```{r}

library(dplyr)
library(corrplot)
library(DescTools)

dane_numeryczne <- dane %>% 
  select(Age, MonthlyIncome, TotalWorkingYears, YearsAtCompany)

# Macierze korelacji (Pearsona)

korelacje <- cor(dane_numeryczne, use = "complete.obs")

# Wykres
corrplot(korelacje, method = "number", type = "upper", diag = FALSE)

# Korelacja rangowa (Kendalla)
korelacje_kendall <- cor(dane_numeryczne, method = "kendall", use = "complete.obs")

# Wykres
corrplot(korelacje_kendall, method = "number", type = "upper", diag = FALSE)

# Korelacja jakościowa (V-Cramera)
tab <- table(dane$Department, dane$JobRole)

# Obliczenie współczynnika
wynik_cramer <- CramerV(tab)
print(paste("Współczynnik V-Cramera:", round(wynik_cramer, 4)))

```

# Wnioskowanie Statystyczne

W tej sekcji zweryfikujemy hipotezy badawcze postawione we wstępie, wykorzystując testy statystyczne.

## Testy normalności rozkładu

Przed wyborem odpowiednich testów (parametryczne vs nieparametryczne) sprawdzamy rozkład zmiennej `MonthlyIncome`.

```{r}
library(nortest)

# Sprawdzamy czy wynagrodzenie ma rozkład normalny
ad_test <- ad.test(dane$MonthlyIncome)

print(paste("Wartość p dla testu normalności wynagrodzenia:", ad_test$p.value))

# Interpretacja automatyczna
if(ad_test$p.value < 0.05) {
  print("Odrzucamy hipotezę o normalności rozkładu. Do analizy zależności zastosujemy testy nieparametryczne (np. U Manna-Whitneya).")
} else {
  print("Rozkład jest normalny.")
}
```

# Odpowiedź na pytanie badawcze nr 1: Wpływ nadgodzin i środowiska
## Czy nadgodziny (OverTime) zwiększają rotację?
```{r}
library(ggstatsplot)

# Test niezależności Chi-kwadrat dla zmiennych kategorycznych
ggbarstats(
  data = dane,
  x = OverTime,       
  y = Attrition,      
  title = "Zależność między nadgodzinami a odejściem z pracy",
  label = "both"      
)
```
Interpretacja: Wykres oraz test statystyczny wskazują na bardzo silną zależność. W grupie pracowników mających nadgodziny (Yes), odsetek odejść jest trzykrotnie wyższy (~30%) niż w grupie pracującej w normie (~10%). Nadgodziny są kluczowym czynnikiem ryzyka.

## Czy zadowolenie ze środowiska (EnvironmentSatisfaction) ma znaczenie?
```{r}
# Przygotowanie danych: zamiana liczb 1-4 na opisowe etykiety
dane_temp <- dane
dane_temp$EnvSatFactor <- factor(dane_temp$EnvironmentSatisfaction, 
                            levels = c(1, 2, 3, 4), 
                            labels = c("Low", "Med", "High", "Very High"))

ggbarstats(
  data = dane_temp,
  x = EnvSatFactor,
  y = Attrition,
  title = "Poziom zadowolenia ze środowiska a rotacja",
  xlab = "Ocena satysfakcji ze środowiska"
)
```
Interpretacja: Widoczny jest trend, w którym pracownicy oceniający środowisko jako "Niskie" (Low) odchodzą częściej niż ci z oceną "Bardzo wysoką" (Very High). Niska satysfakcja z biura/atmosfery sprzyja decyzjom o odejściu.

# Odpowiedź na pytanie badawcze nr 2: Finanse a odejścia
```{r}
# Używamy testu nieparametrycznego (type = "nonparametric") z uwagi na brak rozkładu normalnego
ggbetweenstats(
  data = dane,
  x = Attrition,          
  y = MonthlyIncome,      
  type = "nonparametric", 
  title = "Porównanie zarobków osób, które odeszły i zostały",
  xlab = "Status pracownika (Attrition)",
  ylab = "Miesięczne wynagrodzenie"
)
```
Interpretacja: Test Manna-Whitneya wykazuje istotną różnicę (p < 0.001). Mediana zarobków osób odchodzących (ok. 3200) jest znacznie niższa od mediany osób pozostających w firmie (ok. 5200). Wynagrodzenie jest zatem silnym motywatorem odejść.

# Odpowiedź na pytanie badawcze nr 3: Profil demograficzny (Wiek)
```{r}
ggbetweenstats(
  data = dane,
  x = Attrition,
  y = Age,
  type = "nonparametric",
  title = "Wiek pracowników a decyzja o odejściu",
  xlab = "Status pracownika (Attrition)",
  ylab = "Wiek (Lata)"
)
```

Interpretacja: Osoby decydujące się na odejście są statystycznie młodsze (mediana wieku ~32 lata) niż pracownicy lojalni (mediana ~36 lat). Firma ma największy problem z utrzymaniem młodych talentów.

# Odpowiedź na pytanie badawcze nr 4: Analiza Działów (Departments)
```{r}
ggbarstats(
  data = dane,
  x = Department,
  y = Attrition,
  title = "Procent odejść w poszczególnych działach",
  palette = "Set2"
)
```
Interpretacja: Dział Sprzedaży (Sales) jest najbardziej narażony na rotację – odsetek odejść przekracza tu 20%. Dział Badawczo-Rozwojowy (R&D) cechuje się największą stabilnością kadry.
